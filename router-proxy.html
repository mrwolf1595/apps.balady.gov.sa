<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="icon" type="image/x-icon" href="https://apps.balady.gov.sa/BALADYCDN/Content/images/fav.ico">
</head>
<body>
<script>
(function() {
    const fullURL = window.location.href;
    const params = new URLSearchParams(window.location.search);
    const path = window.location.pathname;
    
    console.log('Full URL:', fullURL);
    console.log('Path:', path);
    
    // جلب key أو data parameter
    let key = params.get('key');
    let data = params.get('data');
    
    console.log('Key found:', key);
    console.log('Data found:', data ? 'Yes' : 'No');
    
    // جدول التوجيه للـ keys
    const keyRoutes = {
        '7e46a31919881b2bf3e5d5ca6f600000': '/index1.html',
        '5047665a19881b2a74ff415dd6c00000': '/index.html'
    };
    
    // تحديد الملف المطلوب
    let targetFile = '/index.html'; // default
    
    // إذا كان في key parameter
    if (key && keyRoutes[key]) {
        targetFile = keyRoutes[key];
        console.log('Route selected by key:', targetFile);
    }
    // إذا كان في data parameter وبدايته bldyPrm
    else if (data && data.startsWith('bldyPrm')) {
        // فك تشفير البيانات وجلب الـ key منها
        try {
            const hexData = data.substring(7); // إزالة "bldyPrm"
            let jsonString = '';
            for (let i = 0; i < hexData.length; i += 2) {
                jsonString += String.fromCharCode(parseInt(hexData.substr(i, 2), 16));
            }
            const decodedData = JSON.parse(jsonString);
            console.log('Decoded data:', decodedData);
            
            // تحديد الملف حسب محتوى البيانات
            // إذا كان في رقم رخصة معين، يروح على index1
            if (decodedData['رقم الرخصة الصادر من الأمانة'] || 
                decodedData['رقم شهادة إشغال'] ||
                Object.keys(decodedData).length > 0) {
                targetFile = '/index1.html';
                console.log('Route selected by data content:', targetFile);
            }
        } catch (e) {
            console.error('Error decoding data:', e);
            // إذا فشل فك التشفير، استخدم index1 كـ fallback للـ data URLs
            targetFile = '/index1.html';
            console.log('Using fallback for data URL:', targetFile);
        }
    }
    // إذا كان الـ path فيه BuildingLicense وما في key
    else if (path.includes('BuildingLicense') && !key) {
        targetFile = '/index1.html';
        console.log('Route selected by BuildingLicense path:', targetFile);
    }
    
    console.log('Final target file:', targetFile);
    
    // تحميل الملف المطلوب فوراً
    fetch(targetFile)
        .then(r => {
            if (!r.ok) {
                throw new Error(`HTTP ${r.status}`);
            }
            return r.text();
        })
        .then(html => {
            console.log('File loaded successfully, replacing content...');
            document.open();
            document.write(html);
            document.close();
        })
        .catch(error => {
            console.error('Error loading file:', error);
            // جرب الملف البديل
            const fallback = targetFile === '/index1.html' ? '/index.html' : '/index1.html';
            console.log('Trying fallback:', fallback);
            
            fetch(fallback)
                .then(r => r.text())
                .then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                })
                .catch(() => window.location.href = '/');
        });
})();
</script>
</body>
</html>