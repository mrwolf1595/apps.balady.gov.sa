<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <title>رمز الاستجابة السريع</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, viewport-fit=cover">
    <link rel="icon" type="image/x-icon" href="https://apps.balady.gov.sa/BALADYCDN/Content/images/fav.ico">
</head>
<body>
    <div id="content-container">
        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
            <h2>جارٍ التحميل...</h2>
            <div id="loading-spinner">⏳</div>
        </div>
    </div>

    <script>
        function getParams() {
            // جلب الـ parameters من الرابط الحالي أو من history
            const urlParams = new URLSearchParams(window.location.search);
            const historyParams = new URLSearchParams(window.location.hash.replace('#', ''));
            
            return {
                fromUrl: urlParams.get('key'),
                fromHistory: historyParams.get('key'),
                current: urlParams.get('key') || historyParams.get('key')
            };
        }
        
        // جدول التوجيه: كل key يروح على ملف معيّن
        const routes = {
            '7e46a31919881b2bf3e5d5ca6f600000': '/index1.html',
            '5047665a19881b2a74ff415dd6c00000': '/index.html'
        };
        
        async function loadTargetFile() {
            const params = getParams();
            const key = params.current;
            
            console.log('Parameters detected:', params);
            console.log('Using key:', key);
            
            let targetFile = '/index.html'; // default
            
            // اختيار الملف حسب الـ key
            if (key && routes[key]) {
                targetFile = routes[key];
            }
            
            console.log('Loading target file:', targetFile);
            
            try {
                // جلب محتوى الملف المطلوب
                const response = await fetch(targetFile);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const htmlContent = await response.text();
                
                // استبدال محتوى الصفحة بالكامل
                document.open();
                document.write(htmlContent);
                document.close();
                
                // تنفيذ أي اسكربتات موجودة في الملف الجديد
                setTimeout(() => {
                    const scripts = document.querySelectorAll('script');
                    scripts.forEach((script, index) => {
                        if (script.innerHTML && !script.executed) {
                            try {
                                console.log(`Executing script ${index + 1}`);
                                eval(script.innerHTML);
                                script.executed = true;
                            } catch (e) {
                                console.error(`Script ${index + 1} execution error:`, e);
                            }
                        }
                    });
                }, 100);
                
            } catch (error) {
                console.error('Error loading file:', error);
                document.getElementById('content-container').innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h2>خطأ في تحميل الصفحة</h2>
                        <p>حدث خطأ أثناء تحميل المحتوى: ${error.message}</p>
                        <p>Key المستخدم: ${key || 'غير محدد'}</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px;">إعادة المحاولة</button>
                        <br>
                        <a href="/" style="color: #007bff;">العودة للصفحة الرئيسية</a>
                    </div>
                `;
            }
        }
        
        // معالجة الأخطاء العامة
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });
        
        // تحميل الملف عند تحميل الصفحة
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadTargetFile);
        } else {
            loadTargetFile();
        }
        
        // معالجة تغييرات الـ URL
        window.addEventListener('popstate', function(event) {
            console.log('URL changed, reloading...');
            loadTargetFile();
        });
    </script>
</body>
</html>